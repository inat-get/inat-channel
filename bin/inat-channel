#!/usr/bin/ruby
require_relative '../lib/inat-channel'
include INatChannel

setup
logger.info "=== iNatChannel Daily Run ==="

# 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ UUIDs
news = load_news
logger.info "Found #{news.size} fresh UUIDs (created_d1=#{CONFIG[:days_back]})"

# 2. –£–±–∏—Ä–∞–µ–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
fresh = news - sent.keys.map { |k| k.to_s }
logger.info "Fresh after filter: #{fresh.size} (excluding #{sent.size} sent)"

if fresh.any?
  # ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ –°–í–ï–ñ–ò–ú: —Å–ª—É—á–∞–π–Ω—ã–π –ò–ó –°–í–ï–ñ–ò–•
  uuid = fresh.sample
  logger.info "üéØ Selected FRESH #{uuid[0..7]}..."
  
  # –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–≤–µ–∂–∏–µ ‚Üí –≤ –ø—É–ª
  remaining_fresh = fresh - [uuid]
  add_to_pool(remaining_fresh) unless remaining_fresh.empty?
  
else
  # 3. –†–µ–∑–µ—Ä–≤: –∏–∑ –ø—É–ª–∞
  uuid = pop_random
  if uuid
    logger.info "üì¶ Selected from POOL #{uuid[0..7]}... (pool was #{pool.size + 1})"
  else
    notify_admin "‚ÑπÔ∏è  No fresh AND pool empty ‚Äî nothing to post today"
    logger.info "‚ÑπÔ∏è  No fresh AND pool empty ‚Äî nothing to post today"
    save
    release_lock
    exit
  end
end

# 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
obs = load_observation(uuid)
if obs
  msg_id = send_observation(obs)
  sent[uuid.intern] = { msg_id: msg_id, sent_at: Time.now.to_s }
  logger.info "‚úÖ Posted #{obs[:id]} (#{list_photos(obs).size} photos)"
else
  logger.warn "‚ùå Failed to load #{uuid} ‚Äî returning to pool"
  pool << uuid if fresh.empty?  # —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—Ä–∞–ª–∏ –∏–∑ –ø—É–ª–∞
end

save

release_lock
logger.info "=== Complete. Pool: #{pool.size} | Sent: #{sent.size} ==="
