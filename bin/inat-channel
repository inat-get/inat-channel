#!/usr/bin/ruby
require_relative '../lib/inat-channel'
include INatChannel

INCh::LOGGER.info "=== iNatChannel Run ==="

news = INCh::API::load_news
INCh::LOGGER.info "Found #{news.size} fresh UUIDs (days_back=#{CONFIG[:days_back]})"

uuid = INCh::Data::select_uuid news

if uuid
  obs = INCh::API::load_observation(uuid)
  if obs
    msg_id = INCh::Telegram::send_observation(obs)
    INCh::Data::sent[uuid] = { msg_id: msg_id, sent_at: Time.now.to_s }
    INCh::LOGGER.info "Posted #{obs[:id]} (#{INCh::Message::list_photos(obs).size} photos)"  # очень плохо, не должно быть тут вызова list_photos
  else
    INCh::LOGGER.warn "Failed to load #{uuid} — returning to pool"
    INCh::Data::pool << uuid 
    INCh::Telegram::notify_admin "Failed to load #{uuid} — returning to pool"
  end

  INCh::Data::save
else
  INCh::Telegram::notify_admin 'No observation to send.'
  INCh::LOGGER.warn 'No observation to send.'
end

