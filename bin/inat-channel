#!/usr/bin/ruby
require_relative '../lib/inat-channel'
include IC

logger.info "=== iNatChannel Run ==="

news = load_news
logger.info "Found #{ news.size } fresh UUIDs (days_back=#{ CONFIG.dig :days_back, :fresh })"

uuid = select_uuid news

if uuid
  obs = load_observation(uuid)
  if obs
    msg_id = send_observation(obs)
    confirm_sending! msg_id
  else
    revert_sending!
    logger.warn "Failed to load #{uuid} — returning to pool"
    notify_admin "Failed to load #{uuid} — returning to pool"
  end

  save_data
else
  notify_admin 'No observation to send.'
  logger.warn 'No observation to send.'
end

