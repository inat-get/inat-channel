
# inat-channel — автопостинг наблюдений


Скрипт, отправляющий в Telegram случайное наблюдение iNaturalist из некоторой выборки.

## Что делает?

+ Получает посредством [API iNaturalist](https://api.inaturalist.org/v2/docs/#/Observations/get_observations) выборку 
  по произвольному запросу (поддерживаемому API).

+ Отправляет случайное наблюдение из выборки в указанный telegram-канал, исключая уже отправленные. Если в свежей выборке 
  новых наблюдений нет, берет из сохраненного пула.

+ Неотправленные наблюдения, полученные по запросу, сохраняет в пул.

+ Уникальность таксонов и глубина пула — настраиваются.

+ При сбоях отправляет сообщение администратоу.

## Установка и запуск

### Посредством Bundler

Создаем `Gemfile` с единственной строкой:
```ruby
gem 'inat-channel', '~> 0.9.0'
```

Выполнить:
```shell
$ bundle install
```

И в дальнейшем пользоваться:
```shell
$ bundle exec inat-channel [options]
```

### Вручную

Устанавливаем:
```shell
gem install inat-channel
```

Запускаем:
```shell
inat-channel [options]
```

Параметров командной строки немного и все они необязательны:

```shell
$ inat-channel --help
Usage: inat-channel [options]
    -c, --config FILE                Config file (default: inat-channel.yml)
    -l, --log-level LEVEL            Log level (default: warn)
        --debug                      Set log level to debug
        --version                    Show version info and exit
    -h, --help                       Show help and exit
```

## Конфигурация

Основные настройки описываются в конфигурационном файле в формате YAML. Опционально можно задать ERB-шаблон сообщения и вынести
группу настроек `places` (см. далее) в отдельный YAML-файл.

Большая часть настроек имеет значения по умолчанию и может не указываться, но есть и обязательные.

### Переменные окружения

Кроме того, **два обязательных параметра** должны быть указаны **в переменных окружения**: `TELEGRAM_BOT_TOKEN` отвечает за токен телеграм-бота,
который вам выдается при его создании через [@BotFather](https://t.me/BotFather) — этого бота (вашего) нужно добавить в ваш канал администратором
и дать ему права на создание сообщений; в переменной `ADMIN_TELEGRAM_ID` следует указать ваш личный ID — по нему будут отправляться 
уведомления — этот ID можно узнать у бота [@Getmyid_bot](https://t.me/Getmyid_bot). Эти параметры не могут быть указаны в конфиг-файле
по соображениям безопасности.

### Конфигурационный файл

Пример:
```yaml
base_query:
  project_id: 175821
  locale: ru
  popular: true
  photo_license: 'cc-by,cc-by-nc,cc-by-nd,cc-by-sa,cc-by-nc-nd,cc-by-nc-sa,cc0'
  quality_grade: research
  
days_back:
  fresh: 30
  pool: 180
  sent: 181
  used: 360
  
unique_taxon: priority

lock_file:
  path: data/data.lock
  ttl: 300
  
data_files:
  root: data
  pool: data/pool.json
  sent: data/sent.json
  used: data/used.json
  
api:
  retries: 5
  interval: 1.0
  randomness: 0.5
  backoff: 2
  page_delay: 1.0
  per_page: 200
  
tg_bot:
  retries: 5
  interval: 1.0
  randomness: 0.5
  backoff: 2
  chat_id: '@<my_test_channel>'
  template: message.erb
  desc_limit: 512
  link_zoom: 12
  
log_level: info
notify_level: warn

places: places.yml
```

Это вполне рабочий (если исправить `tg_bot.chat_id`), хотя и сильно избыточный конфиг. Разберем параметры по частям.

#### Параметры запроса к API

```yaml
base_query:
  project_id: 175821
  locale: ru
  popular: true
  photo_license: 'cc-by,cc-by-nc,cc-by-nd,cc-by-sa,cc-by-nc-nd,cc-by-nc-sa,cc0'
  quality_grade: research
```

Состав этих параметров может быть произвольным, но хотя бы один должен быть указан. Несколько примечаний:
+ В качестве `project_id` можно указать не только числовой идентификатор, но и `slug` проекта, который получить проще — это часть его URL.
+ Локаль влияет на названия таксонов, без ее указания будут выдаваться английские.
+ *Настоятельно рекомендуется указывать лицензии фото*, в противном случае скрипт будет забирать и те наблюдения, фото которых вы не имеете 
  право распространять.
+ Как известно, наблюдения на iNaturalist могут быть самого разного качества. Параметры `quality_grade: research` и `popular: true`
  хоть и не дают никаких гарантий, позволяют несколько улучшить выборку в среднем.

#### Параметры актуальности

```yaml
days_back:
  fresh: 30
  pool: 180
  sent: 181
  used: 360

unique_taxon: priority
```

Группа параметров, управляющая актуальностью и временем жизни данных. 
+ Параметр `days_back.fresh` является *обязательным* и отвечает за число дней, за которые запрашиваются данные при каждом запуске. 
  Есть соблазн его уменьшить в соответствии с периодичностью запуска самого скрипта, но нужно помнить, что ддля получения
  статуса `research`, и тем более, для попадания в популярные (это значит, что как минимум один человек добавил наблюдение
  в избранные) — требуется какое-то дополнительное время. Хотя 30 дней, вероятно, перебор, но хотя бы неделю дать стоит.
+ Параметр `days_back.pool` отвечает за давность наблюдений в пуле. Пул задействуется, если свежих наблюдений в выборке нет, или они
  все уже отправлены. Наблюдения, старше (в днях), чем указано в этом параметре, удаляются из пула. По умолчанию устанавливается
  в значение `days_back.fresh * 3`. Этот же параметр отвечает за первичное заполнение пула при первом запуске.
+ Параметр `days_back.sent` отвечает за хранение списка отправленных. Здесь возраст отсчитывается с даты собственно отправки. Желательно 
  устанавливать его равным `days_back.pool` или на день больше, чтобы не получилось дубликатов (вообще, они не должны попадать в пул, 
  но мало ли...) По умолчанию устанавливается в значение `days_back.pool + 1`.
+ Параметр `days_back.used` отвечает за срок хранения информации о задействованных *таксонах*. По умолчению устанавливается значение `365`,
  т.е. год.
+ `unique_taxon` управляет уникальностью таксонов. Доступны следующие значения:
  + `strict` — наблюдения с одинаковыми таксонами не отправляются (и удаляются из пула);
  + `priority` — наблюдения с таксонами, еще не отправлявшимися, получают приоритет;
  + `ignore` — уникальность/неуникальность таксона игнорируется, данные о таксонах не сохраняются.
  
  По умолчанию `ignore`.

#### Параметры файлов

Данные между запусками скрипт хранит в нескольких файлах в формате JSON. Кроме того, чтобы несколько экземпляров, одновременно выполняющихся,
не повредили данные друг друга, параллельный запуск запрещен, что контролируется через lock-файл.

```yaml
lock_file:
  path: data/data.lock
  ttl: 300
  
data_files:
  root: data
  pool: data/pool.json
  sent: data/sent.json
  used: data/used.json
```

Группа `lock_file` отвечает за собственно lock-файл — его имя файла, а также время жизни — после `lock_file.ttl` секунд lock-файл считается 
просроченным и новый запуск допускается. Это сделано, чтобы в случае сбоя (хотя при большинстве ошибок файл все равно должен быть удален)
запуск не блокировался навсегда.

Группа `data_files` отвечает за размещение собственно файлов данных. При этом `data_files.root` позволяет указать каталог для всех данных,
не указывая их пути по отдельности. В данном примере же, `root` ни на что не влияет, поскольку имена файлов все указаны сами по себе.

#### Параметры сервисов

```yaml
api:
  retries: 5
  interval: 1.0
  randomness: 0.5
  backoff: 2
  page_delay: 1.0
  per_page: 200
  
tg_bot:
  retries: 5
  interval: 1.0
  randomness: 0.5
  backoff: 2
  chat_id: '@<my_test_channel>'
  template: message.erb
  desc_limit: 512
  link_zoom: 12
```  

Две группы параметров отвечают за работу с **[iNaturalist API v2](https://api.inaturalist.org/v2/docs/)**
и **[Telegram Bot API](https://core.telegram.org/bots/api)**.

Четыре первых ключа в этих группах одинаковые и задают параметры [`faraday-retry`](https://github.com/lostisland/faraday-retry). Значения
по умолчанию показаны выше, их можно изменять для тонкой настройки, но как правило этого не требуется. Этот гем отвечает за повторы
при ошибках.

У API iNaturalist есть свои особенности и ограничения. В частности есть ограничение на частоту запросов, для удовлетворения которого
вводится задержка между последовательными вызовами — `api.page_delay`. В отличие от предыдущего, эта задержка работает не в случае
ошибки, а при нормальной работе с API. Параметр `api.per_page` отвечает за количество данных за один запрос, значение `200` — это 
максимум, увеличение его не имеет смысла, а уменьшение замедлит работу. Изменять `api.per_page` и `api.page_delay` может иметь смысл
только в случае изменения условий и ограничений самого API iNaturalist.


